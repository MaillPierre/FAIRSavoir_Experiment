@prefix mf:      <http://www.w3.org/2001/sw/DataAccess/tests/test-manifest#> .
@prefix kgi: <http://ns.inria.fr/kg/index#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

<> a mf:Manifest ;
    mf:entries (
        <root.ttl>
        <summary.ttl>
    ) .

<root.ttl>  a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """
            PREFIX rdfs:       <http://www.w3.org/2000/01/rdf-schema#>
            PREFIX owl:        <http://www.w3.org/2002/07/owl#>
            PREFIX xsd:        <http://www.w3.org/2001/XMLSchema#>
            PREFIX dcat:       <http://www.w3.org/ns/dcat#>
            PREFIX foaf:       <http://xmlns.com/foaf/0.1/>
            PREFIX prov:       <http://www.w3.org/ns/prov#>
            PREFIX schema:		<http://schema.org/>
            PREFIX void:       <http://rdfs.org/ns/void#>
            PREFIX sd:     	<http://www.w3.org/ns/sparql-service-description#>
            PREFIX dct:        <http://purl.org/dc/terms/>
            PREFIX skos:       <http://www.w3.org/2004/02/skos/core#>
            PREFIX kgi:        <http://ns.inria.fr/kg/index#>

            INSERT {
                GRAPH ?curatedDescriptionGraph {
                    ?datasetDescription kgi:summary ?summaryDescriptionGraph .
                }
            } WHERE  {
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Summary")) AS ?summaryDescriptionGraph)
            }
            """
        ]
    ) .

<summary.ttl>  a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            kgi:timeout "PT120S"^^xsd:duration ;
            kgi:recommendedPagination 100 ;
            mf:action """
            PREFIX rdfs:       <http://www.w3.org/2000/01/rdf-schema#>
            PREFIX owl:        <http://www.w3.org/2002/07/owl#>
            PREFIX xsd:        <http://www.w3.org/2001/XMLSchema#>
            PREFIX dcat:       <http://www.w3.org/ns/dcat#>
            PREFIX foaf:       <http://xmlns.com/foaf/0.1/>
            PREFIX prov:       <http://www.w3.org/ns/prov#>
            PREFIX schema:		<http://schema.org/>
            PREFIX void:       <http://rdfs.org/ns/void#>
            PREFIX sd:     	<http://www.w3.org/ns/sparql-service-description#>
            PREFIX dct:        <http://purl.org/dc/terms/>
            PREFIX skos:       <http://www.w3.org/2004/02/skos/core#>
            PREFIX kgi:        <http://ns.inria.fr/kg/index#>

            INSERT {
                GRAPH ?summaryDescriptionGraph {
                    ?subjectAuthority ?p ?objectAuthority .
                }
            } WHERE  {
                SERVICE $rawEndpointUrl {
                    SELECT DISTINCT ((IRI(REPLACE(str(?s), ?subjectUrlEnd, "", "q" ))) AS ?subjectAuthority) ?p ((IRI(REPLACE(str(?o), ?objectUrlEnd, "", "q" ))) AS ?objectAuthority) WHERE {
                        ?s ?p ?o .
                        FILTER(isIri(?s))
                        FILTER(isIri(?o))
                        BIND( REPLACE(str(?s), "^[a-z][a-z0-9+.]*://([a-z0-9._~%!$&'()*+,;=]+@)?([a-z0-9-._~%]+|[a-f0-9:.]+|[[a-f0-9][a-z0-9-._~%!$&'()*+,;=:]+])(:[0-9]+)?", "") AS ?subjectUrlEnd)
                        BIND( REPLACE(str(?o), "^[a-z][a-z0-9+.]*://([a-z0-9._~%!$&'()*+,;=]+@)?([a-z0-9-._~%]+|[a-f0-9:.]+|[[a-f0-9][a-z0-9-._~%!$&'()*+,;=:]+])(:[0-9]+)?", "") AS ?objectUrlEnd)
                    }
                }
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Summary")) AS ?summaryDescriptionGraph)
            }
            """
        ]
        [
            kgi:timeout "PT120S"^^xsd:duration ;
            kgi:recommendedPagination 100 ;
            mf:action """
            PREFIX rdfs:       <http://www.w3.org/2000/01/rdf-schema#>
            PREFIX owl:        <http://www.w3.org/2002/07/owl#>
            PREFIX xsd:        <http://www.w3.org/2001/XMLSchema#>
            PREFIX dcat:       <http://www.w3.org/ns/dcat#>
            PREFIX foaf:       <http://xmlns.com/foaf/0.1/>
            PREFIX prov:       <http://www.w3.org/ns/prov#>
            PREFIX schema:		<http://schema.org/>
            PREFIX void:       <http://rdfs.org/ns/void#>
            PREFIX sd:     	<http://www.w3.org/ns/sparql-service-description#>
            PREFIX dct:        <http://purl.org/dc/terms/>
            PREFIX skos:       <http://www.w3.org/2004/02/skos/core#>
            PREFIX kgi:        <http://ns.inria.fr/kg/index#>

            INSERT {
                GRAPH ?summaryDescriptionGraph {
                    ?subjectAutority ?p "lit" .
                }
            } WHERE  {
                SERVICE $rawEndpointUrl {
                    SELECT DISTINCT ((IRI(REPLACE(str(?s), ?subjectUrlEnd, "", "q" ))) AS ?subjectAutority) ?p WHERE {
                        ?s ?p ?o .
                        FILTER(isIri(?s))
                        FILTER(isLiteral(?o))
                        BIND( REPLACE(str(?s), "^[a-z][a-z0-9+.]*://([a-z0-9._~%!$&'()*+,;=]+@)?([a-z0-9-._~%]+|[a-f0-9:.]+|[[a-f0-9][a-z0-9-._~%!$&'()*+,;=:]+])(:[0-9]+)?", "") AS ?subjectUrlEnd)
                    }
                }
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Summary")) AS ?summaryDescriptionGraph)
            }
            """
        ]
    ) .
