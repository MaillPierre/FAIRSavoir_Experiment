@prefix mf: <http://www.w3.org/2001/sw/DataAccess/tests/test-manifest#> .
@prefix sd: <http://www.w3.org/ns/sparql-service-description#> .
@prefix kgi: <http://ns.inria.fr/kg/index#> .
@prefix earl: <http://www.w3.org/ns/earl#> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

<> a mf:Manifest ;
    mf:entries  (
            <sportalClassPartition.ttl>
            <sportalPropertyPartition.ttl>
        ) .

<classPopulation.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX prov: <http://www.w3.org/ns/prov#>
                PREFIX earl: <http://www.w3.org/ns/earl#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?metadataDescriptionGraph {
                        ?datasetDescription prov:wasGeneratedBy <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/classPopulation.ttl#activity> .
                        <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/classPopulation.ttl#activity> prov:used <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/classPopulation.ttl> ;
                            prov:wasAssociatedWith <https://orcid.org/0000-0002-9814-439X> .
                    }
                }
                WHERE {
                    BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                    BIND(Iri(CONCAT(str(kgi:), MD5(CONCAT(str($rawEndpointUrl), str(?class))), "ClassPartition")) AS ?classPartition)
                    BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Metadata")) AS ?metadataDescriptionGraph)
                }
            """
        ]
        [
            kgi:timeout "PT120S"^^xsd:duration ;
            kgi:recommendedPagination 100 ;
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX prov: <http://www.w3.org/ns/prov#>
                PREFIX earl: <http://www.w3.org/ns/earl#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription void:classPartition ?classPartition .
                        ?classPartition void:class ?class ;
                                void:entities ?count .
                    }
                }
                WHERE {
                    SERVICE $rawEndpointUrl {
                        {
                            SELECT ?class (count(?instance) AS ?count)
                            WHERE {
                                SELECT DISTINCT ?class ?instance
                                WHERE {
                                    ?instance a ?class
                                }
                            } GROUP BY ?class
                        }
                    }
                    BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                    BIND(Iri(CONCAT(str(kgi:), MD5(CONCAT(str($rawEndpointUrl), str(?class))), "ClassPartition")) AS ?classPartition)
                    BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
                }
            """
        ]
    ) .

<sportalClassPartition.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX prov: <http://www.w3.org/ns/prov#>
                PREFIX prov: <http://www.w3.org/ns/prov#>
            PREFIX earl: <http://www.w3.org/ns/earl#>
            PREFIX kgi: <http://ns.inria.fr/kg/index#>
            PREFIX void: <http://rdfs.org/ns/void#>
                INSERT {
                    GRAPH ?metadataDescriptionGraph {
                        ?datasetDescription prov:wasGeneratedBy <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/sportalClassPartition.ttl#activity> .
                        <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/sportalClassPartition.ttl#activity> prov:used <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/sportalClassPartition.ttl> ;
                            prov:wasAssociatedWith <https://orcid.org/0000-0002-9814-439X> .
                    }
                }
                WHERE {
                    BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                    BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Metadata")) AS ?metadataDescriptionGraph)
                }
            """
        ]
        [
            kgi:timeout "PT120S"^^xsd:duration ;
            kgi:recommendedPagination 500 ;
            mf:action """PREFIX prov: <http://www.w3.org/ns/prov#>
                PREFIX prov: <http://www.w3.org/ns/prov#>
            PREFIX earl: <http://www.w3.org/ns/earl#>
            PREFIX kgi: <http://ns.inria.fr/kg/index#>
            PREFIX void: <http://rdfs.org/ns/void#>
                INSERT {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription void:classPartition ?classPartition .
                        ?classPartition void:class ?c .
                    }
                }
                WHERE {
                    SERVICE $rawEndpointUrl {
                        { ?s a ?c . }
                    }
                    BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                    BIND(Iri(CONCAT(str(kgi:), MD5(CONCAT(str($rawEndpointUrl), str(?c))), "ClassPartition")) AS ?classPartition)
                    BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
                }
            """
        ]
        <classPopulation.ttl>
    ) .

<sportalPropertyPartition.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
            PREFIX kgi: <http://ns.inria.fr/kg/index#>
            PREFIX prov: <http://www.w3.org/ns/prov#>
            INSERT {
                GRAPH ?metadataDescriptionGraph {
                    ?propertyPartition void:property ?p .
                    ?datasetDescription prov:wasGeneratedBy <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/sportalPropertyPartition.ttl#activity> .
                    <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/sportalPropertyPartition.ttl#activity> prov:used <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/sportalPropertyPartition.ttl> ;
                        prov:wasAssociatedWith <https://orcid.org/0000-0002-9814-439X> .
                }
            }
            WHERE {
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Metadata")) AS ?metadataDescriptionGraph)
            }"""
        ]
        [
            kgi:timeout "PT120S"^^xsd:duration ;
            kgi:recommendedPagination 500 ;
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
            PREFIX kgi: <http://ns.inria.fr/kg/index#>
            PREFIX prov: <http://www.w3.org/ns/prov#>
            INSERT {
                GRAPH ?curatedDescriptionGraph {
                    ?datasetDescription void:propertyPartition ?propertyPartition .
                }
            }
            WHERE {
                SERVICE $rawEndpointUrl {
                    { SELECT DISTINCT ?p WHERE { ?s ?p ?o } }
                }
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                BIND(Iri(CONCAT(str(kgi:), MD5(CONCAT(str($rawEndpointUrl), str(?p))), "PropertyPartition")) AS ?propertyPartition)
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
            }"""
        ]
        <sportalPropertyPartitionTriples.ttl>
    ) .

<sportalPropertyPartitionTriples.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
            PREFIX prov: <http://www.w3.org/ns/prov#>
            PREFIX kgi: <http://ns.inria.fr/kg/index#>
            INSERT {
                GRAPH ?metadataDescriptionGraph {
                    ?datasetDescription prov:wasGeneratedBy <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/sportalPropertyPartitionTriples.ttl#activity> .
                    <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/sportalPropertyPartitionTriples.ttl#activity> prov:used <https://raw.githubusercontent.com/Wimmics/IndeGx/main/rules/statistics/sportalPropertyPartitionTriples.ttl> ;
                        prov:wasAssociatedWith <https://orcid.org/0000-0002-9814-439X> .
                }
            }
            WHERE {
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Metadata")) AS ?metadataDescriptionGraph)
            }"""
        ]
        [
            kgi:timeout "PT120S"^^xsd:duration ;
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
            PREFIX prov: <http://www.w3.org/ns/prov#>
            PREFIX kgi: <http://ns.inria.fr/kg/index#>
            INSERT {
                GRAPH ?curatedDescriptionGraph {
                    ?datasetDescription void:propertyPartition ?propertyPartition .
                    ?propertyPartition void:property ?p ;
                        void:triples ?x .
                }
            }
            WHERE {
                SERVICE $rawEndpointUrl {
                    { SELECT (COUNT(?o) AS ?x) ?p WHERE { ?s ?p ?o } GROUP BY ?p }
                }
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                BIND(Iri(CONCAT(str(kgi:), MD5(CONCAT(str($rawEndpointUrl), str(?p))), "PropertyPartition")) AS ?propertyPartition)
                BIND(Iri(CONCAT(str(kgi:), MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
            }"""
        ]
    ) .