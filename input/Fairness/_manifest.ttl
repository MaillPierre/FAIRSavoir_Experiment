@prefix mf: <http://www.w3.org/2001/sw/DataAccess/tests/test-manifest#> .
@prefix kgi: <http://ns.inria.fr/kg/index#> .

<> a mf:Manifest ;
    mf:entries (
        <dataset_description_extraction.ttl>
    ) .

<dataset_description_extraction.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """
            PREFIX void: <http://rdfs.org/ns/void#>
            PREFIX dcat: <http://www.w3.org/ns/dcat#>
            PREFIX dcmitype: <http://purl.org/dc/dcmitype/>
            PREFIX schema: <http://schema.org/>
            PREFIX sd: <http://www.w3.org/ns/sparql-service-description#>
            PREFIX prov: <http://www.w3.org/ns/prov#>
            PREFIX pav: <http://purl.org/pav/>
            PREFIX foaf: <http://xmlns.com/foaf/0.1/>
            PREFIX dce: <http://purl.org/dc/elements/1.1/>
            PREFIX dcterms: <http://purl.org/dc/terms/>
            PREFIX dataid: <http://dataid.dbpedia.org/ns/core#>
            INSERT {
                GRAPH ?kgGraph {
                    ?kg ?p ?o .
                }
            } WHERE {
                SERVICE $rawEndpointUrl {
                    # Find the KG : is a Dataset
                    { ?kg a dcat:Dataset }
                    UNION { ?kg a void:Dataset }
                    UNION { ?kg a dcmitype:Dataset }
                    UNION { ?kg a schema:Dataset }
                    UNION { ?kg a sd:Dataset }
                    UNION { ?kg a dataid:Dataset }

                    # is linked directly or not to the endpoint
                    { ?kg ?endpointLink $rawEndpointUrl . }
                    UNION {?kg dcat:accessService ?service .
                           ?service dcat:endpointURL $rawEndpointUrl .  }
                    UNION {?kg dcat:accessService ?service .
                           ?service sd:endpoint $rawEndpointUrl . }
                    UNION {?service dcat:servesDataset ?kg .
                           ?service dcat:endpointURL $rawEndpointUrl . }
                    UNION {?service dcat:servesDataset ?kg .
                           ?service sd:endpoint $rawEndpointUrl . }
                    ?kg ?p ?o .
                }
                BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str(?kg)), "Graph")) AS ?kgGraph)
            }
            """
        ]
        [
            mf:action """
            PREFIX void: <http://rdfs.org/ns/void#>
            PREFIX dcat: <http://www.w3.org/ns/dcat#>
            PREFIX dcmitype: <http://purl.org/dc/dcmitype/>
            PREFIX schema: <http://schema.org/>
            PREFIX sd: <http://www.w3.org/ns/sparql-service-description#>
            PREFIX prov: <http://www.w3.org/ns/prov#>
            PREFIX pav: <http://purl.org/pav/>
            PREFIX foaf: <http://xmlns.com/foaf/0.1/>
            PREFIX dce: <http://purl.org/dc/elements/1.1/>
            PREFIX dcterms: <http://purl.org/dc/terms/>
            PREFIX dataid: <http://dataid.dbpedia.org/ns/core#>
            INSERT {
                GRAPH ?kgGraph {
                    ?s ?p ?kg .
                }
            } WHERE {
                SERVICE $rawEndpointUrl {
                    # Find the KG : is a Dataset
                    { ?kg a dcat:Dataset }
                    UNION { ?kg a void:Dataset }
                    UNION { ?kg a dcmitype:Dataset }
                    UNION { ?kg a schema:Dataset }
                    UNION { ?kg a sd:Dataset }
                    UNION { ?kg a dataid:Dataset }

                    # is linked directly or not to the endpoint
                    { ?kg ?endpointLink $rawEndpointUrl . }
                    UNION {?kg dcat:accessService ?service .
                           ?service dcat:endpointURL $rawEndpointUrl .  }
                    UNION {?kg dcat:accessService ?service .
                           ?service sd:endpoint $rawEndpointUrl . }
                    UNION {?service dcat:servesDataset ?kg .
                           ?service dcat:endpointURL $rawEndpointUrl . }
                    UNION {?service dcat:servesDataset ?kg .
                           ?service sd:endpoint $rawEndpointUrl . }
                    ?s ?p ?kg .
                }
                BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "Graph")) AS ?kgGraph)
            }
            """
        ]
    ) ;
    kgi:onFailure (
        [
            mf:action """
                PREFIX prov: <http://www.w3.org/ns/prov#>
                PREFIX dqv: <http://www.w3.org/ns/dqv#>
                PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX dcat: <http://www.w3.org/ns/dcat#>
                PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
                PREFIX earl: <http://www.w3.org/ns/earl#>
                PREFIX sd: <http://www.w3.org/ns/sparql-service-description#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?kgGraph {
                        # Creation of the description
                        ?endpointDescription sd:endpoint $rawEndpointUrl ;
                            a sd:Service, dcat:DataService , prov:Entity , earl:TestSubject ;
                            dcat:endpointURL $rawEndpointUrl ;
                            rdfs:comment "No Dataset related with the IRI of the endpoint url was found." ;
                            prov:wasGeneratedBy <https://raw.githubusercontent.com/Jendersen/KG_accountability/main/nonTrivialExtractionRules/simpleExtraction.ttl#activity> ;
                            prov:generatedAtTime ?time .

                    }
                } WHERE {
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "Graph")) AS ?kgGraph)
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "Endpoint")) AS ?endpointDescription)
                    BIND(NOW() AS ?time)
                }
            """
        ]
    ) .