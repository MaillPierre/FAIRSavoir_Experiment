@prefix mf: <http://www.w3.org/2001/sw/DataAccess/tests/test-manifest#> .
@prefix kgi: <http://ns.inria.fr/kg/index#> .

<> a mf:Manifest ;
    mf:entries (
            <properties.ttl>
            <resourceHostname.ttl>
        ) .

<properties.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription void:propertyPartition ?newPropertyPartition .
                        ?newPropertyPartition void:property ?propertyOfSummary .
                    }
                }
                WHERE {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription kgi:summary ?summaryDescriptionGraph .
                    }
                    GRAPH ?summaryDescriptionGraph {
                        ?s ?propertyOfSummary ?o .
                    }
                    FILTER(NOT EXISTS( GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription void:propertyPartition ?propertyPartition .
                        ?propertyPartition void:property ?propertyOfSummary .
                    } ) )
                    FILTER(! strstarts(str(?property), "http://www.w3.org/2001/XMLSchema#"))
                    FILTER(! strstarts(str(?property), "http://www.w3.org/2000/01/rdf-schema#"))
                    FILTER(! strstarts(str(?property), "http://www.w3.org/1999/02/22-rdf-syntax-ns#"))
                    FILTER(! strstarts(str(?property), "http://www.w3.org/2002/07/owl#"))
                    BIND(Iri(CONCAT(str(kgi:), MD5(CONCAT(str(?propertyOfSummary))), "PropertyPartition")) AS ?newPropertyPartition)
                }
            """
        ]
    ) .

<resourceHostname.ttl> a mf:ManifestEntry ;
kgi:onSuccess (
    [
        mf:action """PREFIX void: <http://rdfs.org/ns/void#>
            PREFIX kgi: <http://ns.inria.fr/kg/index#>
            INSERT {
                GRAPH ?curatedDescriptionGraph {
                    ?datasetDescription void:propertyPartition ?newPropertyPartition .
                    ?newHostnamePartition kgi:resourceHostname ?hostnameOfSummary .
                }
            }
            WHERE {
                GRAPH ?curatedDescriptionGraph {
                    ?datasetDescription kgi:summary ?summaryDescriptionGraph .
                }
                GRAPH ?summaryDescriptionGraph {
                    ?hostnameOfSummary ?p ?o .
                }
                FILTER(NOT EXISTS( GRAPH ?curatedDescriptionGraph {
                    ?datasetDescription void:propertyPartition ?hostnamePartition .
                    ?hostnamePartition kgi:resourceHostname ?hostnameOfSummary .
                } ) )
                BIND(Iri(CONCAT(str(kgi:), MD5(CONCAT(str(?ns))), "HostnamePartition" )) AS ?newHostnamePartition)
            }
        """
    ]
    [
        mf:action """PREFIX void: <http://rdfs.org/ns/void#>
            PREFIX kgi: <http://ns.inria.fr/kg/index#>
            INSERT {
                GRAPH ?curatedDescriptionGraph {
                    ?datasetDescription void:propertyPartition ?newPropertyPartition .
                    ?newHostnamePartition kgi:resourceHostname ?hostnameOfSummary .
                }
            }
            WHERE {
                GRAPH ?curatedDescriptionGraph {
                    ?datasetDescription kgi:summary ?summaryDescriptionGraph .
                }
                GRAPH ?summaryDescriptionGraph {
                    ?s ?p ?hostnameOfSummary .
                }
                FILTER(isIRI(?hostnameOfSummary))
                FILTER(NOT EXISTS( GRAPH ?curatedDescriptionGraph {
                    ?datasetDescription void:propertyPartition ?hostnamePartition .
                    ?hostnamePartition kgi:resourceHostname ?hostnameOfSummary .
                } ) )
                BIND(Iri(CONCAT(str(kgi:), MD5(CONCAT(str(?ns))), "HostnamePartition" )) AS ?newHostnamePartition)
            }
        """
    ]
) .
