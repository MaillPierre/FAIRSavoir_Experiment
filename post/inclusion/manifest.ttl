@prefix mf: <http://www.w3.org/2001/sw/DataAccess/tests/test-manifest#> .
@prefix kgi: <http://ns.inria.fr/kg/index#> .

<> a mf:Manifest ;
    mf:entries (
            <inclusionByVocabularies.ttl>
            <inclusionByDatatypes.ttl>
            <inclusionByClasses.ttl>
            <inclusionByProperties.ttl>
            <inclusionByResourceHostname.ttl>
        ) .

<inclusionByVocabularies.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription kgi:commonVocabularies ?otherDatasetDescription .
                    }
                    GRAPH ?otherCuratedDescriptionGraph {
                        ?otherDatasetDescription kgi:commonVocabularies ?datasetDescription .
                    }
                }
                WHERE {
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                    {
                        SELECT DISTINCT ?otherDatasetDescription {
                            GRAPH ?curatedDescriptionGraph {
                                ?datasetDescription void:sparqlEndpoint $rawEndpointUrl .
                                ?datasetDescription void:vocabulary ?vocab .
                            }
                            GRAPH ?otherCuratedDescriptionGraph {
                                ?otherDatasetDescription void:sparqlEndpoint ?otherEndpointUrl .
                                ?otherDatasetDescription void:vocabulary ?vocab .
                            }
                            FILTER(str(?otherDatasetDescription) < str(?datasetDescription))
                            FILTER( NOT EXISTS { GRAPH ?curatedDescriptionGraph { ?datasetDescription kgi:commonVocabularies ?otherDatasetDescription . } } )
                            FILTER(?vocab != <http://www.w3.org/2001/XMLSchema#>)
                            FILTER(?vocab != <http://www.w3.org/2000/01/rdf-schema#>)
                            FILTER(?vocab != <http://www.w3.org/1999/02/22-rdf-syntax-ns#>)
                            FILTER(?vocab != <http://www.w3.org/2002/07/owl#>)
                        }
                    }
                }
            """
        ]
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription kgi:commonVocabularies ?otherDatasetDescription ;
                            kgi:commonVocabularyDescription ?commonVocabularyResource .
                        ?commonVocabularyResource a kgi:VocabularyCommonalityDescription ;
                            kgi:vocabulary ?vocab ;
                            kgi:dataset ?datasetDescription ;
                            kgi:dataset ?otherDatasetDescription .
                    }
                    GRAPH ?otherCuratedDescriptionGraph {
                        ?otherDatasetDescription kgi:commonVocabularies ?datasetDescription ;
                            kgi:commonVocabularyDescription ?commonVocabularyResource .
                        ?commonVocabularyResource a kgi:VocabularyCommonalityDescription ;
                            kgi:vocabulary ?vocab ;
                            kgi:dataset ?datasetDescription ;
                            kgi:dataset ?otherDatasetDescription .
                    }
                }
                WHERE {
                    {
                        SELECT DISTINCT ?otherDatasetDescription {
                            GRAPH ?curatedDescriptionGraph {
                                ?datasetDescription void:sparqlEndpoint ?endpointUrl .
                                ?datasetDescription void:vocabulary ?vocab .
                            }
                            GRAPH ?otherCuratedDescriptionGraph {
                                ?otherDatasetDescription void:sparqlEndpoint ?otherEndpointUrl .
                                ?otherDatasetDescription void:vocabulary ?vocab .
                            }
                            FILTER(str(?otherDatasetDescription) < str(?datasetDescription))
                            FILTER( NOT EXISTS { 
                                GRAPH ?curatedDescriptionGraph { 
                                    ?datasetDescription kgi:commonVocabularyDescription ?commonVocabularyResource . 
                                    ?commonVocabularyResource kgi:vocabulary ?vocab . 
                                } 
                            } )
                            FILTER(?vocab != <http://www.w3.org/2001/XMLSchema#>)
                            FILTER(?vocab != <http://www.w3.org/2000/01/rdf-schema#>)
                            FILTER(?vocab != <http://www.w3.org/1999/02/22-rdf-syntax-ns#>)
                            FILTER(?vocab != <http://www.w3.org/2002/07/owl#>)
                            BIND(Iri(CONCAT(str(kgi:), MD5(CONCAT(str(?endpointUrl), str(?otherEndpointUrl))), "CommonVocabularies")) AS ?commonVocabularyResource)
                        }
                    }
                }
            """
        ]
    ) .

<inclusionByDatatypes.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription kgi:commonDatatypes ?otherDatasetDescription .
                    }
                    GRAPH ?otherCuratedDescriptionGraph {
                        ?otherDatasetDescription kgi:commonDatatypes ?datasetDescription .
                    }
                }
                WHERE {
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                    {
                        SELECT DISTINCT ?otherDatasetDescription {
                            GRAPH ?otherCuratedDescriptionGraph {
                                ?datasetDescription void:sparqlEndpoint $rawEndpointUrl .
                                ?otherDatasetDescription kgi:availableLiteralDatatypes ?datatype .
                            }
                            GRAPH ?curatedDescriptionGraph {
                                ?otherDatasetDescription void:sparqlEndpoint ?otherEndpointUrl .
                                ?datasetDescription kgi:availableLiteralDatatypes ?datatype .
                            }
                            FILTER(str(?otherDatasetDescription) < str(?datasetDescription))
                            FILTER(?datatype != <http://www.w3.org/1999/02/22-rdf-syntax-ns#langString>)
                            FILTER(?datatype != <http://www.w3.org/2001/XMLSchema#string> )
                            FILTER( NOT EXISTS { GRAPH ?curatedDescriptionGraph { ?datasetDescription kgi:commonDatatypes ?otherDatasetDescription . } } )
                        }
                    }
                }
            """
        ]
    ) .

<inclusionByClasses.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription kgi:commonClasses ?otherDatasetDescription .
                    }
                    GRAPH ?otherCuratedDescriptionGraph {
                        ?otherDatasetDescription kgi:commonClasses ?datasetDescription .
                    }
                }
                WHERE {
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                    {
                        SELECT DISTINCT ?otherDatasetDescription {
                            GRAPH ?curatedDescriptionGraph {
                                ?datasetDescription void:sparqlEndpoint $rawEndpointUrl .
                                ?datasetDescription void:classPartition ?classPartition .
                                ?classPartition void:class ?class .
                            }
                            GRAPH ?otherCuratedDescriptionGraph {
                                ?otherDatasetDescription void:sparqlEndpoint ?otherEndpointUrl .
                                ?otherDatasetDescription void:classPartition ?otherClassPartition .
                                ?otherClassPartition void:class ?class .
                            }
                            FILTER(str(?otherDatasetDescription) < str(?datasetDescription))
                            FILTER(! strstarts(str(?class), "http://www.w3.org/2001/XMLSchema#"))
                            FILTER(! strstarts(str(?class), "http://www.w3.org/2000/01/rdf-schema#"))
                            FILTER(! strstarts(str(?class), "http://www.w3.org/1999/02/22-rdf-syntax-ns#"))
                            FILTER(! strstarts(str(?class), "http://www.w3.org/2002/07/owl#"))
                            FILTER( NOT EXISTS { GRAPH ?curatedDescriptionGraph {  ?datasetDescription kgi:commonClasses ?otherDatasetDescription . } } )
                        }
                    }
                }
            """
        ]
        <inclusionByClassesAndProperties.ttl>
    ) .

<inclusionByProperties.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription kgi:commonProperties ?otherDatasetDescription .
                    }
                    GRAPH ?otherCuratedDescriptionGraph {
                        ?otherDatasetDescription kgi:commonProperties ?datasetDescription .
                    }
                }
                WHERE {
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                    {
                        SELECT DISTINCT ?otherDatasetDescription {
                            GRAPH ?curatedDescriptionGraph {
                                ?datasetDescription void:sparqlEndpoint $rawEndpointUrl .
                                ?datasetDescription void:propertyPartition ?propertyPartition .
                                ?propertyPartition void:property ?property .
                            }
                            GRAPH ?otherCuratedDescriptionGraph {
                                ?otherDatasetDescription void:sparqlEndpoint ?otherEndpointUrl .
                                ?otherDatasetDescription void:propertyPartition ?otherPropertyPartition .
                                ?otherPropertyPartition void:property ?property .
                            }
                            FILTER(str(?otherDatasetDescription) < str(?datasetDescription))
                            FILTER(! strstarts(str(?property), "http://www.w3.org/2001/XMLSchema#"))
                            FILTER(! strstarts(str(?property), "http://www.w3.org/2000/01/rdf-schema#"))
                            FILTER(! strstarts(str(?property), "http://www.w3.org/1999/02/22-rdf-syntax-ns#"))
                            FILTER(! strstarts(str(?property), "http://www.w3.org/2002/07/owl#"))
                            FILTER( NOT EXISTS { GRAPH ?curatedDescriptionGraph { ?datasetDescription kgi:commonProperties ?otherDatasetDescription . } } )
                        }
                    }
                }
            """
        ]
        <inclusionByClassesAndProperties.ttl>
    ) .

<inclusionByClassesAndProperties.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription kgi:commonClasses ?otherDatasetDescription .
                    }
                    GRAPH ?otherCuratedDescriptionGraph {
                        ?otherDatasetDescription kgi:commonClasses ?datasetDescription .
                    }
                }
                WHERE {
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                    {
                        SELECT DISTINCT ?otherDatasetDescription {
                            GRAPH ?curatedDescriptionGraph {
                                ?datasetDescription void:sparqlEndpoint $rawEndpointUrl .
                                ?datasetDescription kgi:availableLiteralDatatypes ?datatype .
                                ?datasetDescription void:classPartition ?classPartition .
                                ?datasetDescription void:propertyPartition ?propertyPartition .
                                ?propertyPartition void:property ?property .
                                ?classPartition void:class ?class .
                            }
                            GRAPH ?otherCuratedDescriptionGraph {
                                ?otherDatasetDescription void:sparqlEndpoint ?otherEndpointUrl .
                                ?otherDatasetDescription void:classPartition ?otherClassPartition .
                                ?otherDatasetDescription void:propertyPartition ?otherPropertyPartition .
                                ?otherPropertyPartition void:property ?property .
                                ?otherClassPartition void:class ?class .
                                ?otherDatasetDescription kgi:availableLiteralDatatypes ?datatype .
                            }
                            FILTER(?otherDatasetDescription < ?datasetDescription)
                            FILTER( NOT EXISTS { GRAPH ?curatedDescriptionGraph { ?datasetDescription kgi:commonClasses ?otherDatasetDescription . } } )
                        }
                    }
                }
            """
        ]
    ) .

<inclusionByResourceHostname.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            mf:action """PREFIX void: <http://rdfs.org/ns/void#>
                PREFIX kgi: <http://ns.inria.fr/kg/index#>
                INSERT {
                    GRAPH ?curatedDescriptionGraph {
                        ?datasetDescription kgi:commonResourceHostname ?otherDatasetDescription .
                    }
                    GRAPH ?otherCuratedDescriptionGraph {
                        ?otherDatasetDescription kgi:commonResourceHostname ?datasetDescription .
                    }
                }
                WHERE {
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "_", DAY(NOW()), "-", MONTH(NOW()), "-", YEAR(NOW()) , "_" , "Curated")) AS ?curatedDescriptionGraph)
                    BIND(Iri(CONCAT("http://ns.inria.fr/kg/index#", MD5(str($rawEndpointUrl)), "Dataset")) AS ?datasetDescription)
                    {
                        SELECT DISTINCT ?otherDatasetDescription {
                            GRAPH ?curatedDescriptionGraph {
                                ?datasetDescription void:sparqlEndpoint $rawEndpointUrl .
                                ?datasetDescription kgi:resourceHostname ?resourceHostname .
                            }
                            GRAPH ?otherCuratedDescriptionGraph {
                                ?otherDatasetDescription void:sparqlEndpoint ?otherEndpointUrl .
                                ?otherDatasetDescription kgi:resourceHostname ?resourceHostname .
                            }
                            FILTER(str(?otherDatasetDescription) < str(?datasetDescription))
                            FILTER( NOT EXISTS { GRAPH ?curatedDescriptionGraph { ?datasetDescription kgi:commonResourceHostname ?otherDatasetDescription . } } )
                        }
                    }
                }
            """
        ]
    ) .

<inclusionByTriples.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            kgi:endpoint kgi:federation ;
            mf:action """
            """
        ]
    ) .

<inclusionByHostnameCoOccurence.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            kgi:endpoint kgi:federation ;
            mf:action """
            """
        ]
    ) .

# Inclusion if cooccurence of the same hostnames appear in two different bases
<inclusionByHostnameCoOccurence.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            kgi:endpoint kgi:federation ;
            mf:action """
            """
        ]
    ) .

<inclusionByStarPatterns.ttl> a mf:ManifestEntry ;
    kgi:onSuccess (
        [
            kgi:endpoint kgi:federation ;
            mf:action """
            """
        ]
    ) .
